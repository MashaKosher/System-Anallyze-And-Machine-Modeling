# Лабораторная работа 3: Статистический анализ имитационной модели

## Описание

Данная лабораторная работа выполняет статистический анализ имитационной модели сложной системы (билетные кассы на автовокзале) из лабораторной работы 2. Проводится комплексный статистический анализ двух откликов модели для принятия обоснованных решений о параметрах моделирования.

## Цель работы

Для стационарного состояния имитационной модели провести статистический анализ по двум откликам:
- **Среднее время ожидания в очереди** (avg_wait_time) - время от прибытия пассажира до начала обслуживания
- **Среднее время пребывания в системе** (avg_system_time) - полное время от прибытия до завершения обслуживания

## Теоретическая основа

### Статистические методы

1. **Критерий хи-квадрат для проверки нормальности**: Сравнивает эмпирическое распределение с теоретическим нормальным распределением
2. **Доверительные интервалы**: Используется t-распределение Стьюдента для малых выборок (n < 30)
3. **t-тесты**: Для сравнения средних значений двух выборок
4. **Анализ чувствительности**: Вычисление коэффициентов эластичности для оценки влияния параметров

## Структура работы

### Задача 1: Проверка нормальности распределения откликов

**Цель**: Проверить, можно ли считать распределения откликов нормальными для применения параметрических статистических методов.

**Методология**:
- Выполняется 100 повторных прогонов модели (длинные прогоны)
- Применяется критерий хи-квадрат Пирсона
- Дополнительно используются тесты Shapiro-Wilk и D'Agostino для подтверждения

**Критерий хи-квадрат**:
- Данные разбиваются на интервалы (bins)
- Вычисляются ожидаемые частоты для нормального распределения с параметрами (μ, σ), оцененными по выборке
- Статистика: χ² = Σ((наблюдаемая - ожидаемая)² / ожидаемая)
- Степени свободы: k - 3 (k - количество интервалов, -3 за оценку μ, σ и объединение интервалов)

**Почему это важно**: 
- Если распределение нормальное → можно использовать параметрические методы (t-тесты, доверительные интервалы на основе нормального распределения)
- Если распределение ненормальное → нужны непараметрические методы или преобразования данных

**Интерпретация результатов**:
- **p-value < 0.05**: Гипотеза о нормальности ОТВЕРГНУТА → распределение не нормальное
- **p-value ≥ 0.05**: Гипотеза о нормальности ПРИНЯТА → распределение можно считать нормальным

**Типичный результат**: В большинстве случаев распределения откликов отклоняются от нормального (p-value ≈ 0), что характерно для систем массового обслуживания из-за асимметрии и выбросов.

---

### Задача 2: Точечные и интервальные оценки откликов

**Цель**: Получить точечные оценки (средние значения) и интервальные оценки (доверительные интервалы) для откликов модели. **Важно**: Перед вычислением оценок проверяется стационарность состояния системы.

**Проверка стационарности**:
Перед вычислением статистических оценок необходимо убедиться, что система находится в стационарном состоянии. Для этого используются два теста:

1. **Сравнение первой и второй половины прогонов** (t-тест):
   - Разделяем 20 прогонов на две группы (первые 10 и последние 10)
   - Сравниваем средние значения откликов в этих группах
   - **H₀**: Средние равны (состояние стационарно)
   - **H₁**: Средние различаются (возможна нестационарность)
   - **Критерий**: p-value > 0.05 → состояние стационарно

2. **Проверка тренда** (корреляция Пирсона):
   - Проверяем корреляцию между номером прогона и значением отклика
   - **H₀**: Нет корреляции (нет тренда, состояние стационарно)
   - **H₁**: Есть корреляция (есть тренд, возможна нестационарность)
   - **Критерий**: p-value > 0.05 → нет значимого тренда

**Обоснование**: Для стационарного состояния средние значения откликов не должны зависеть от времени (номера прогона). Если обнаружена нестационарность, результаты статистического анализа могут быть некорректными.

**Методология**:
- Выполняется 20 повторных прогонов модели
- Для каждого прогона вычисляется среднее время ожидания и пребывания
- Используется уровень значимости α = 0.05 (доверительная вероятность 95%)

**Точечная оценка**:
- Выборочное среднее: x̄ = (1/n)Σxᵢ
- Это наилучшая оценка истинного среднего значения отклика

**Доверительный интервал**:
- Для малых выборок (n = 20 < 30) используется t-распределение Стьюдента
- Формула: x̄ ± t₀.₀₂₅,₁₉ × (s/√n)
  - t₀.₀₂₅,₁₉ - критическое значение t-распределения с 19 степенями свободы
  - s - выборочное стандартное отклонение
  - n - размер выборки

**Почему t-распределение, а не нормальное?**
- При малых выборках (n < 30) выборочное среднее имеет распределение, близкое к t-распределению
- t-распределение имеет более "тяжелые хвосты", что дает более широкие интервалы и консервативные оценки

**Интерпретация**:
- **Доверительный интервал [a, b]**: С вероятностью 95% истинное среднее значение лежит в этом интервале
- **Ширина интервала**: Показывает неопределенность оценки
- **Относительная погрешность**: (полуширина интервала / среднее) × 100% - показывает точность оценки в процентах

**Типичный результат**: При 20 прогонах относительная погрешность обычно составляет 15-20%, что указывает на необходимость большего количества прогонов для повышения точности.

---

### Задача 3: Зависимость точности от количества прогонов

**Цель**: Определить оптимальное количество повторных прогонов для достижения заданной точности (5% погрешность).

**Методология**:
- Выполняется 100 прогонов модели
- Для каждого количества прогонов N (5, 10, 15, ..., 100) вычисляется:
  - Относительная погрешность: (t × SE / x̄) × 100%
  - Ширина доверительного интервала
  - Стандартная ошибка: SE = s/√N

**Математическая основа**:
- Стандартная ошибка среднего убывает как 1/√N
- Для уменьшения погрешности в 2 раза нужно увеличить N в 4 раза
- Относительная погрешность = (t₀.₀₂₅,ₙ₋₁ × s) / (x̄ × √N) × 100%

**Почему это важно**:
- **Экономия времени**: Не нужно выполнять избыточное количество прогонов
- **Обеспечение точности**: Гарантирует достаточное количество прогонов для надежных результатов
- **Планирование экспериментов**: Позволяет заранее оценить необходимое время моделирования

**Интерпретация результатов**:
- **N для 5% погрешности**: Минимальное количество прогонов, при котором относительная погрешность ≤ 5%
- **График зависимости**: Показывает, как быстро улучшается точность с увеличением N
- **Асимптотическое поведение**: При больших N улучшение точности замедляется

**Типичный результат**: Для достижения 5% погрешности обычно требуется 100+ прогонов, что связано с высокой вариативностью откликов в системах массового обслуживания.

---

### Задача 4: Анализ переходного периода

**Цель**: Определить переходный период модели и проверить возможность его исключения для ускорения моделирования.

**Методология**:
- Создается модифицированная модель, отслеживающая отклики во времени
- Вычисляются бегущие средние откликов по мере завершения обслуживаний
- Переходный период определяется как первые 20% наблюдений или первые 50 пассажиров
- Сравниваются средние значения в переходном и стационарном периодах

**Бегущее среднее**:
- Для каждого k-го обслуженного пассажира: x̄ₖ = (1/k)Σᵢ₌₁ᵏ xᵢ
- Показывает, как среднее значение "стабилизируется" во времени

**Статистический тест**:
- Используется t-тест для независимых выборок (ttest_ind)
- Нулевая гипотеза H₀: средние в переходном и стационарном периодах равны
- Альтернативная гипотеза H₁: средние различаются

**Почему это важно**:
- **Переходный период**: Начальный период, когда система "разогревается" и отклики нестабильны
- **Исключение переходного периода**: Позволяет получить более точные оценки стационарных характеристик
- **Экономия времени**: Можно начинать сбор статистики после завершения переходного периода

**Интерпретация результатов**:
- **p-value < 0.05**: Средние различаются → переходный период существенен, его нужно исключать
- **p-value ≥ 0.05**: Средние не различаются → переходный период несущественен
- **Разница средних**: Показывает, насколько переходный период влияет на итоговые оценки

**Типичный результат**: Переходный период обычно существенен (p-value ≈ 0), так как в начале моделирования система пуста и отклики сильно отличаются от стационарных значений.

---

### Задача 5: Проверка гипотезы о непрерывном прогоне

**Цель**: Сравнить два подхода к моделированию:
1. Множественные короткие прогоны (20 прогонов по 8 часов)
2. Один длинный непрерывный прогон (160 часов = 20 × 8)

**Методология**:
- Выполняются оба типа прогонов
- Длинный прогон разбивается на 20 интервалов для анализа
- Сравниваются распределения откликов
- Проверяется стационарность длинного прогона

**Статистические тесты**:
1. **ttest_1samp**: Сравнивает средние интервалов длинного прогона с общим средним коротких прогонов
2. **ttest_ind**: Сравнивает первую и вторую половину длинного прогона для проверки стационарности

**Почему это важно**:
- **Короткие прогоны**: 
  - Преимущества: Независимость наблюдений, возможность оценки дисперсии
  - Недостатки: Каждый прогон имеет переходный период
- **Длинный прогон**:
  - Преимущества: Один переходный период, больше данных
  - Недостатки: Зависимость наблюдений, возможная нестационарность

**Критерии принятия решения**:
- **Стационарность**: Если первая и вторая половины длинного прогона не различаются (p-value > 0.05) → прогон стационарен
- **Согласованность**: Если средние интервалов длинного прогона согласуются со средним коротких прогонов (p-value > 0.05) → подходы эквивалентны

**Интерпретация результатов**:
- **Длинный прогон стационарен**: Можно использовать непрерывный прогон для экономии времени
- **Длинный прогон нестационарен**: Рекомендуется использовать множественные короткие прогоны

**Типичный результат**: Если длинный прогон стационарен (p-value > 0.05 для сравнения половин), его можно использовать, что экономит время на инициализацию множественных прогонов.

---

### Задача 6: Анализ чувствительности откликов

**Цель**: Оценить, насколько чувствительны отклики к изменениям параметров модели, и определить достаточную точность задания переменных.

**Методология**:
- Вариации ключевых параметров:
  - `arrival_rate`: ±20% (0.8, 0.9, 1.0, 1.1, 1.2)
  - `service_rate_per_booth`: ±14% (0.30, 0.325, 0.35, 0.375, 0.40)
  - `num_booths`: дискретные значения (3, 4, 5)
- Для каждого варианта выполняется прогон модели
- Вычисляются коэффициенты эластичности

**Коэффициент эластичности**:
- Эластичность = (ΔY/Y) / (ΔX/X) = (процентное изменение отклика) / (процентное изменение параметра)
- **Эластичность > 1**: Отклик более чувствителен, чем параметр (эластичный)
- **Эластичность = 1**: Пропорциональная зависимость
- **Эластичность < 1**: Отклик менее чувствителен, чем параметр (неэластичный)
- **Эластичность < 0**: Отрицательная зависимость (увеличение параметра уменьшает отклик)

**Достаточная точность задания переменной**:
- Определяется минимальное изменение параметра, приводящее к изменению отклика ≥ 1%
- Это показывает, с какой точностью нужно задавать параметры модели

**Почему это важно**:
- **Планирование экспериментов**: Показывает, какие параметры требуют более точного задания
- **Оптимизация**: Выявляет наиболее влиятельные параметры для оптимизации системы
- **Валидация модели**: Помогает определить, какие параметры критичны для точности модели

**Интерпретация результатов**:
- **Высокая эластичность** (|E| > 2): Параметр очень влиятелен, требует высокой точности задания
- **Средняя эластичность** (1 < |E| ≤ 2): Параметр умеренно влиятелен
- **Низкая эластичность** (|E| < 1): Параметр слабо влиятелен, может задаваться с меньшей точностью

**Типичный результат**: 
- `arrival_rate` обычно имеет высокую положительную эластичность (E > 3) → очень чувствителен
- `service_rate_per_booth` имеет отрицательную эластичность (E ≈ -2) → увеличение скорости обслуживания уменьшает время ожидания
- `num_booths` имеет высокую отрицательную эластичность → добавление касс значительно уменьшает время ожидания

---

## Структура файлов

- `lab3_statistical_analysis.ipynb` - основной Jupyter Notebook с решением всех задач
- `README.md` - данный файл с подробным описанием

## Зависимости

- Python 3.x
- numpy - для численных вычислений
- matplotlib - для визуализации результатов
- scipy - для статистических тестов и распределений
- Стандартные библиотеки Python (dataclasses, typing, heapq, random, math)

## Использование

1. Откройте `lab3_statistical_analysis.ipynb` в Jupyter Notebook или JupyterLab
2. Выполните ячейки последовательно (важно соблюдать порядок!)
3. Результаты будут отображены в виде:
   - Текстовых выводов с численными результатами и интерпретацией
   - Графиков и диаграмм для визуального анализа
   - Таблиц со статистиками

## Время выполнения

- Задача 1: ~2-3 минуты (100 прогонов)
- Задача 2: ~30 секунд (20 прогонов)
- Задача 3: ~2-3 минуты (100 прогонов)
- Задача 4: ~30 секунд (1 прогон с временными рядами)
- Задача 5: ~5-10 минут (1 длинный прогон 160 часов)
- Задача 6: ~2-3 минуты (13 вариантов параметров)

**Общее время**: ~15-20 минут

## Доказательства стационарности состояния

Для обоснования использования статистических методов необходимо доказать, что система находится в стационарном состоянии. В работе используются следующие проверки:

### 1. Независимость от номера прогона (Задача 2)
- **Метод**: Сравнение средних значений первой и второй половины прогонов (t-тест)
- **Результат**: Если p-value > 0.05 → средние не различаются → состояние стационарно
- **Визуализация**: График значений откликов по номерам прогонов (должен быть без тренда)

### 2. Отсутствие тренда (Задача 2)
- **Метод**: Корреляция Пирсона между номером прогона и значением отклика
- **Результат**: Если p-value > 0.05 → нет значимого тренда → состояние стационарно
- **Визуализация**: Линия тренда на графике (должна быть горизонтальной)

### 3. Стационарность длинного прогона (Задача 5)
- **Метод**: Сравнение первой и второй половины длинного прогона
- **Результат**: Если p-value > 0.05 → длинный прогон стационарен
- **Обоснование**: Если длинный прогон стационарен, можно использовать непрерывный прогон

### Критерии принятия решения о стационарности:
- ✓ **Состояние стационарно**, если:
  - Средние первой и второй половины прогонов не различаются (p > 0.05)
  - Нет значимого тренда (p > 0.05 для корреляции)
  - Длинный прогон стационарен (p > 0.05 для сравнения половин)

- ⚠ **Есть признаки нестационарности**, если:
  - Средние различаются между половинами (p ≤ 0.05)
  - Обнаружен тренд (p ≤ 0.05 для корреляции)

**Важно**: Если обнаружена нестационарность, рекомендуется:
- Увеличить длительность каждого прогона
- Исключить больше начальных данных (увеличить переходный период)
- Использовать методы для нестационарных процессов

---

## Ключевые выводы и рекомендации

### 1. Нормальность распределений
- **Вывод**: Распределения откликов обычно отклоняются от нормального
- **Рекомендация**: Использовать t-распределение для доверительных интервалов (учитывает отклонение от нормальности)

### 2. Количество прогонов
- **Вывод**: Для достижения 5% погрешности требуется 100+ прогонов
- **Рекомендация**: Использовать не менее 50-100 прогонов для надежных результатов

### 3. Переходный период
- **Вывод**: Переходный период существенен и влияет на оценки
- **Рекомендация**: Исключать первые 20% наблюдений или первые 50 обслуженных пассажиров

### 4. Непрерывный vs множественные прогоны
- **Вывод**: Если длинный прогон стационарен, его можно использовать
- **Рекомендация**: Проверять стационарность длинного прогона перед использованием

### 5. Чувствительность параметров
- **Вывод**: `arrival_rate` и `num_booths` наиболее влиятельны
- **Рекомендация**: Задавать эти параметры с высокой точностью (±5-10%)

## Примечания

- Модель из Lab2 полностью интегрирована в данный notebook
- Все вычисления выполняются на основе имитационной модели билетных касс
- Результаты могут варьироваться в зависимости от случайных чисел (seed = 42 для воспроизводимости)
- Функция `format_pvalue()` обеспечивает корректное отображение очень малых p-value

## Дополнительная информация

### О p-value

**p-value** - это вероятность получить наблюдаемый результат (или более крайний) при условии, что нулевая гипотеза верна.

- **p-value < 0.05**: Сильные доказательства против нулевой гипотезы → гипотеза ОТВЕРГНУТА
- **p-value ≥ 0.05**: Недостаточно доказательств против нулевой гипотезы → гипотеза ПРИНЯТА

**Важно**: p-value не говорит о вероятности того, что гипотеза верна, а только о вероятности данных при условии верности гипотезы.

### О доверительных интервалах

Доверительный интервал 95% означает:
- Если повторить эксперимент 100 раз, в 95 случаях истинное значение будет лежать в интервале
- Это НЕ означает, что с вероятностью 95% истинное значение лежит в конкретном интервале

### О статистической значимости

Статистическая значимость (p-value < 0.05) не всегда означает практическую значимость:
- Малое p-value может быть получено при больших выборках даже для малых различий
- Всегда нужно оценивать размер эффекта (разницу средних, ширину интервалов)
