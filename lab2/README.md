## Лабораторная 2 — «Билетные кассы на автовокзале»

Моделирование работы 4 касс с отдельными очередями, технологическими перерывами и выбором пассажиром «приблизительно наименьшей» очереди. Реализовано в виде дискретно‑событийной модели в ноутбуке `lab2_bus_station.ipynb` (без внешних библиотек моделирования).

### Цель
Исследовать динамику очередей, время ожидания пассажиров и загрузку касс при:
- выборе очереди по текущей длине (с небольшой «нерациональностью»),
- наличии технологических перерывов (объявление перерыва и возможная миграция в другие очереди).

### Концептуальная модель
- **Пассажир**: время прибытия, выбранная касса, времена начала/окончания обслуживания, флаг ухода/ожидания перерыва.
- **Касса**: состояние (работает/анонс перерыва/перерыв), очередь, скорость обслуживания, расписание перерывов (цикл 45 мин работы + 15 мин перерыв), время оповещения `T_announce` до перерыва.
- **Очередь**: список пассажиров у каждой кассы.

### Процессы
1) **Прибытие пассажиров**: пуассоновский поток (экспоненциальные межприходы).
2) **Выбор очереди**: алгоритм «приблизительно минимальная длина» с допуском ±`approx_delta` и «случайной ошибкой» с вероятностью `epsilon_random`.
3) **Обслуживание**: экспоненциальное время. Если обслуживание попадает на перерыв — прерывается и продолжается после перерыва.
4) **Оповещение и перерыв**: за `T_announce` до перерыва касса входит в режим анонса; часть ожидающих может мигрировать в другие очереди.

### Ключевые параметры (редактируются в ноутбуке)
- `arrival_rate` (λ, пасс./мин): интенсивность прибытия пассажиров.
- `service_rate_per_booth` (μ, пасс./мин): скорость обслуживания одной кассы.
- `num_booths` = 4: число касс.
- `work_minutes` = 45.0: длительность работы в цикле.
- `break_minutes` = 15.0: длительность перерыва в цикле.
- `announce_minutes` (`T_announce`): за сколько минут до перерыва делается объявление.
- `approx_delta`: допуск по длине очереди при выборе (±шт.).
- `epsilon_random`: вероятность выбрать не оптимальную очередь.
- `announce_migrate_prob`: вероятность миграции каждого ожидающего из очереди объявляющей кассы.
- `announce_penalty`: штраф к «воспринимаемой длине» очереди во время анонса (чтобы пассажиры реже её выбирали).
- `max_wait_time` (опц.): лимит ожидания, при превышении пассажир уходит.

### Основные события модели
- `arrival`: прибытие пассажира и постановка в выбранную очередь.
- `service_end`: завершение обслуживания.
- `announce`: касса объявляет скорый перерыв; возможна миграция.
- `break_start` / `break_end`: старт/конец технологического перерыва, планируется циклически (45/15 мин).

### Выходные показатели (метрики)
- **Среднее время ожидания в очереди**: \( \overline{W_q} = \sum (t_{start} - t_{arr}) / N_{serv} \).
- **Среднее время пребывания в системе**: \( \overline{W} = \sum (t_{end} - t_{arr}) / N_{serv} \).
- **Средняя длина очереди (временнáя средняя) по каждой кассе**: \( \overline{L_q^{(i)}} = \int L_q^{(i)}(t)\,dt / T \).
- **Число пассажиров, ожидавших перерыв** (обслуживание прервалось и продолжилось после перерыва).
- **Общее число обслуженных пассажиров**.
- **Число ушедших из системы** (если задан лимит ожидания).

### Как запустить
1) Откройте ноутбук `lab2/lab2_bus_station.ipynb` в Jupyter (Lab/Notebook).
2) При необходимости подправьте словарь `PARAMS` (верхняя кодовая ячейка) под ваш сценарий.
3) Запустите все ячейки (Run All). В конце будет словарь с рассчитанными метриками.

Пример интерпретации результатов:
- `avg_wait_time` — среднее время ожидания в очереди (мин).
- `avg_system_time` — среднее время в системе (ожидание + обслуживание).
- `avg_queue_lengths` — список средних длин очередей по кассам (по времени за весь горизонт моделирования).
- `num_waited_over_break` — сколько пассажиров фактически попали на перерыв во время обслуживания и ждали его окончания.
- `num_completed` / `num_abandoned` — обслуженные / ушедшие.

### Допущения и поведение
- Пассажиры видят приблизительные длины очередей; в режиме анонса у кассы повышенная «воспринимаемая» длина (штраф), поэтому новые пассажиры реже её выбирают.
- При наступлении перерыва текущее обслуживание прерывается; остаток времени переносится сразу после окончания перерыва.
- Во время анонса каждый ожидающий в очереди объявившей кассы с вероятностью `announce_migrate_prob` может мигрировать в другую очередь (по тому же правилу выбора).
- Если включён `max_wait_time`, часть пассажиров может уходить, не вставая в очередь на перерыве или ожидая слишком долго.

### Что и где смотреть в коде (в ноутбуке)
- Классы: `Passenger`, `TicketBooth`, `DES` (движок), `BusStationModel` (логика системы).
- Алгоритм выбора очереди — метод `choose_booth_for_passenger`.
- Логика анонса/перерывов — события `announce`, `break_start`, `break_end` и методы `on_announce`, `on_break_start`, `on_break_end`.
- Подсчёт метрик — класс `Metrics` и вспомогательная функция `compute_results`.

### Идеи для экспериментов
- Варьируйте `arrival_rate` и `service_rate_per_booth` (нагрузка) и смотрите, как меняются метрики.
- Изменяйте `approx_delta`, `epsilon_random`, `announce_penalty` — влияние «нерациональности» выбора и анонса на распределение по очередям.
- Меняйте длительность и частоту перерывов (`work_minutes`, `break_minutes`, `announce_minutes`).
- Включите/выключите `max_wait_time` и оцените долю ушедших.


